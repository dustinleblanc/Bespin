<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bespin - Cloud Job Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8">Welcome to Bespin</h1>
        <p class="text-center text-gray-600 mb-8">Your cloud development platform</p>

        <div class="max-w-md mx-auto">
            <button id="generateBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50">
                Generate Random Text
            </button>

            <div id="result" class="mt-8 p-4 bg-gray-100 rounded hidden">
                <h2 class="font-bold mb-2">Generated Text:</h2>
                <p id="resultText" class="text-gray-700"></p>
            </div>

            <div id="error" class="mt-4 p-4 bg-red-100 text-red-700 rounded hidden"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generateBtn');
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('resultText');
            const errorDiv = document.getElementById('error');

            let socket = null;

            // Initialize socket connection
            function initSocket() {
                const apiUrl = 'http://localhost:3002';

                console.log('Connecting to API at:', apiUrl);

                // Create socket connection
                socket = io(apiUrl, {
                    transports: ['polling'],
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    timeout: 30000,
                    forceNew: true,
                    autoConnect: true
                });

                console.log('Socket.IO client initialized');

                // Socket connection event handlers
                socket.on('connect', () => {
                    console.log('Connected to server with ID:', socket.id);
                    console.log('Transport used:', socket.io.engine.transport.name);
                    errorDiv.classList.add('hidden');
                });

                socket.on('connect_error', (err) => {
                    console.error('Connection error:', err);
                    errorDiv.textContent = 'Failed to connect to server: ' + err.message;
                    errorDiv.classList.remove('hidden');
                });

                socket.on('error', (err) => {
                    console.error('Socket error:', err);
                    errorDiv.textContent = 'Socket error: ' + (err.message || 'Unknown error');
                    errorDiv.classList.remove('hidden');
                });

                // Listen for reconnection attempts
                socket.io.on('reconnect_attempt', (attempt) => {
                    console.log(`Reconnection attempt ${attempt}...`);
                });

                socket.io.on('reconnect', () => {
                    console.log('Reconnected to server');
                    errorDiv.classList.add('hidden');
                });

                socket.io.on('reconnect_failed', () => {
                    console.error('Failed to reconnect');
                    errorDiv.textContent = 'Failed to reconnect to server after multiple attempts';
                    errorDiv.classList.remove('hidden');
                });
            }

            // Initialize socket
            initSocket();

            // Create a new job
            async function createJob() {
                if (!socket) {
                    errorDiv.textContent = 'Not connected to server';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                try {
                    // Update UI state
                    generateBtn.disabled = true;
                    generateBtn.textContent = 'Generating...';
                    errorDiv.classList.add('hidden');
                    resultDiv.classList.add('hidden');

                    // Send job request to API
                    const response = await fetch('http://localhost:3002/api/jobs/random-text', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ length: 100 })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create job');
                    }

                    // Get the job ID from the response
                    const { jobId } = await response.json();
                    console.log('Job created with ID:', jobId);

                    // Listen for job completion
                    console.log(`Setting up listener for job-completed:${jobId}`);
                    socket.once(`job-completed:${jobId}`, (jobResult) => {
                        console.log('Job completed event received:', jobResult);

                        // Parse the result if it's a string
                        let result = jobResult;
                        if (typeof jobResult === 'string') {
                            try {
                                result = JSON.parse(jobResult);
                            } catch (e) {
                                console.error('Error parsing job result:', e);
                            }
                        }

                        // Display the result
                        resultText.textContent = result.result || result;
                        resultDiv.classList.remove('hidden');

                        // Reset button
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Generate Random Text';
                    });
                } catch (err) {
                    // Handle errors
                    console.error('Error creating job:', err);
                    errorDiv.textContent = err instanceof Error ? err.message : 'An error occurred';
                    errorDiv.classList.remove('hidden');

                    // Reset button
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Random Text';
                }
            }

            // Add event listener to button
            generateBtn.addEventListener('click', createJob);

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
            });
        });
    </script>
</body>
</html>
